---
title: "2024_AlpineStrategy_distributionmodeling"
author: "Michelle DePrenger-Levin"
date: "2024-04-17"
output: html_document
---

```{r}

library(raster) ## says getData will be removed, use geodata instead
library(geodata)
## library(rgdal) # retired in 2023. move to sf/stars/terra with GDAL and PROJ
# library(maptools) # retired in 2023; same for rgeos; no longer active maintainer

library(terra)
library(maps)
library(sf)
library(devtools)
devtools::install_github("rsbivand/sp@evolution")
Sys.setenv("_SP_EVOLUTION_STATUS_"=2)  ## so that sp will call sf::st_crs() to validate coordinate reference system

library(prism)
library(ggplot2)
library(usmap)
library(tidyterra)

```


World Climate data
 standard (19) WorldClim Bioclimatic variables for WorldClim version 2. They are the average for the years 1970-2000.

    BIO1 = Annual Mean Temperature  
    BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))  
    BIO3 = Isothermality (BIO2/BIO7) (* 100)  
    BIO4 = Temperature Seasonality (standard deviation *100)  
    BIO5 = Max Temperature of Warmest Month  
    BIO6 = Min Temperature of Coldest Month  
    BIO7 = Temperature Annual Range (BIO5-BIO6)   
    BIO8 = Mean Temperature of Wettest Quarter  
    BIO9 = Mean Temperature of Driest Quarter  
    BIO10 = Mean Temperature of Warmest Quarter  
    BIO11 = Mean Temperature of Coldest Quarter  
    BIO12 = Annual Precipitation  
    BIO13 = Precipitation of Wettest Month  
    BIO14 = Precipitation of Driest Month  
    BIO15 = Precipitation Seasonality (Coefficient of Variation)  
    BIO16 = Precipitation of Wettest Quarter  
    BIO17 = Precipitation of Driest Quarter  
    BIO18 = Precipitation of Warmest Quarter  
    BIO19 = Precipitation of Coldest Quarter   
    
    
This is WorldClim version 2.1 climate data for 1970-2000. This version was released in January 2020.       
Variable	Description	Unit    

    tmin	minimum temperature	°C    
    tmax	maximum temperature	°C    
    tavg	average temperature	°C    
    prec	total precipitation	mm    
    srad	incident solar radiation	kJ m-2 day-1    
    wind	wind speed (2 m above the ground)	m s-1   
    vapr	vapor pressure	kPa   


They aren't in the same projection
```{r}

# bioclim_data <- raster::getData("worldclim", var = 'bio', res = 0.5, lon = 105, lat = 40)
bioclim_data <- geodata::worldclim_tile('bio', res = 0.5, lon = 105, lat = 40, path=tempdir())
gadm_data <- geodata::gadm(country = "USA",  path=tempdir(), level = 2)

plot(bioclim_data[[1]])
plot(gadm_data, add = TRUE, col = "blue", legend = FALSE)


state <- map_data("state")
ggplot(data = state, aes(x = long, y = lat, fill = region, group = group))+
  geom_polygon(color = "white")+ 
  guides(fill=FALSE) + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) + 
  ggtitle('U.S. Map with States') + 
  coord_fixed(1.3)

CO_NM <- subset(state, region %in% c("colorado","new mexico"))
counties <- map_data("county")
CONM_counties <- subset(counties, region %in% c("colorado","new mexico"))

ggplot(data=CO_NM, mapping=aes(x=long, y=lat, group=group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color="black", fill="gray") + 
  geom_polygon(data=CONM_counties, fill=NA, color="white") + 
  geom_polygon(color="black", fill=NA) + 
  ggtitle('Colorado and New Mexico Map with Counties') + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank())

# overlay a SpatVector
ggplot()+
  geom_spatraster(data = bioclim_data[[1]]) +
  # facet_wrap(~lyr, ncol = 2)  +
  scale_fill_whitebox_c(
    palette = "muted",
    labels = scales::label_number(suffix = "º"),
    n.breaks = 12,
    guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    fill = "",
    title = "Annual Mean Temperature ",
    subtitle = "Colorado"
  ) +
  geom_sf(data = gadm_data, fill = "white")

terra::crs(gadm_data, describe = TRUE) ## EPSG 4326
terra::crs(bioclim_data, describe = TRUE) ## EPSG 4326, -180, 180, 90, -90

```


Download GBIF records   
    
    Includes 'research grade' iNat observations
```{r}
phal <- sp_occurrence("Physaria", "alpina*", download = TRUE)

head(phal)

ggplot(bioclim_data[[1]])+
  geom_raster()

```

